<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>SpaceSim Constellation Dashboard</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .panel {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .panel h3 {
            margin-top: 0;
            color: #4FC3F7;
            border-bottom: 2px solid #4FC3F7;
            padding-bottom: 10px;
        }
        
        .satellite-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .satellite-table th,
        .satellite-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #444;
        }
        
        .satellite-table th {
            background-color: #333;
            color: #4FC3F7;
        }
        
        .status-nominal { color: #4CAF50; }
        .status-fail { color: #F44336; }
        .attitude-detumbling { color: #FF9800; }
        .attitude-solar { color: #FFC107; }
        .attitude-nadir { color: #4CAF50; }
        
        .chart-container {
            height: 300px;
            margin-top: 15px;
            background: #333;
            border-radius: 4px;
            padding: 10px;
            position: relative;
        }
        
        .chart-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #888;
            font-style: italic;
        }
        
        .mission-info {
            grid-column: 1 / -1;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .stat-box {
            background: #333;
            padding: 15px;
            border-radius: 4px;
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #4FC3F7;
        }
        
        .stat-label {
            font-size: 0.9em;
            color: #ccc;
            margin-top: 5px;
        }

        .refresh-info {
            position: fixed;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 4px;
            font-size: 0.9em;
        }

        canvas {
            width: 100%;
            height: 100%;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="refresh-info">
        Auto-refresh: <span id="refreshStatus">Connecting...</span>
    </div>

    <div class="header">
        <h1>üõ∞Ô∏è SpaceSim Constellation Dashboard</h1>
        <p>Real-time monitoring of satellite constellation status</p>
        <p><a href="index.html" style="color: #4FC3F7; text-decoration: none;">üåç Back to 3D Visualizer</a></p>
    </div>

    <div class="dashboard-grid">
        <!-- Mission Overview -->
        <div class="panel mission-info">
            <h3>Mission Status</h3>
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-value" id="satelliteCount">0</div>
                    <div class="stat-label">Active Satellites</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="missionTime">--:--:--</div>
                    <div class="stat-label">Mission Time</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="timeScale">1.0x</div>
                    <div class="stat-label">Time Scale</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="healthySats">0</div>
                    <div class="stat-label">Healthy</div>
                </div>
            </div>
        </div>

        <!-- Satellite Status Table -->
        <div class="panel">
            <h3>Satellite Status</h3>
            <table class="satellite-table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Mode</th>
                        <th>Attitude</th>
                        <th>Battery</th>
                        <th>Uptime</th>
                    </tr>
                </thead>
                <tbody id="satelliteTableBody">
                    <tr><td colspan="5" style="text-align: center; color: #888;">No data available</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Battery Levels Chart -->
        <div class="panel">
            <h3>Battery Levels</h3>
            <div class="chart-container">
                <canvas id="batteryChart"></canvas>
            </div>
        </div>

        <!-- Altitude Distribution -->
        <div class="panel">
            <h3>Orbital Altitudes</h3>
            <div class="chart-container">
                <canvas id="altitudeChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        let batteryChart, altitudeChart;
        let telemetryHistory = {};

        // Initialize charts
        function initCharts() {
            // Battery Chart
            const batteryCtx = document.getElementById('batteryChart').getContext('2d');
            batteryChart = new Chart(batteryCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: []
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#ffffff' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#ffffff' },
                            grid: { color: '#444' }
                        },
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { color: '#ffffff' },
                            grid: { color: '#444' }
                        }
                    }
                }
            });

            // Altitude Chart
            const altitudeCtx = document.getElementById('altitudeChart').getContext('2d');
            altitudeChart = new Chart(altitudeCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Altitude (km)',
                        data: [],
                        backgroundColor: '#4FC3F7',
                        borderColor: '#29B6F6',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: { color: '#ffffff' }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#ffffff' },
                            grid: { color: '#444' }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#ffffff' },
                            grid: { color: '#444' }
                        }
                    }
                }
            });
        }

        // Fetch telemetry data
        async function fetchTelemetry() {
            try {
                const response = await fetch('/telemetry');
                const data = await response.json();
                return Array.isArray(data) ? data : [];
            } catch (e) {
                console.warn('Failed to fetch telemetry:', e);
                return [];
            }
        }

        // Format time duration
        function formatDuration(seconds) {
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            const secs = Math.floor(seconds % 60);
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Update dashboard
        function updateDashboard(telemetry) {
            if (!telemetry || telemetry.length === 0) {
                document.getElementById('refreshStatus').textContent = 'No data';
                return;
            }

            document.getElementById('refreshStatus').textContent = 'Connected';

            // Update mission stats
            const activeSats = telemetry.length;
            const healthySats = telemetry.filter(sat => sat.satellite_status?.health === 'nominal').length;
            
            document.getElementById('satelliteCount').textContent = activeSats;
            document.getElementById('healthySats').textContent = healthySats;

            if (telemetry[0]?.mission_time) {
                const missionDate = new Date(telemetry[0].mission_time);
                document.getElementById('missionTime').textContent = missionDate.toISOString().slice(11, 19);
            }

            if (telemetry[0]?.time_scale) {
                document.getElementById('timeScale').textContent = `${telemetry[0].time_scale}x`;
            }

            // Update satellite table
            const tableBody = document.getElementById('satelliteTableBody');
            tableBody.innerHTML = '';

            telemetry.forEach(sat => {
                const row = document.createElement('tr');
                const status = sat.satellite_status || {};
                
                row.innerHTML = `
                    <td>${sat.name || sat.sat_id}</td>
                    <td><span class="status-${status.mode || 'nominal'}">${status.mode || 'unknown'}</span></td>
                    <td><span class="attitude-${(status.attitude_mode || 'unknown').replace('_', '')}">${status.attitude_mode || 'unknown'}</span></td>
                    <td>${(sat.battery_pct || 0).toFixed(1)}%</td>
                    <td>${formatDuration(status.uptime_seconds || 0)}</td>
                `;
                tableBody.appendChild(row);
            });

            // Update charts
            updateBatteryChart(telemetry);
            updateAltitudeChart(telemetry);
        }

        // Update battery chart
        function updateBatteryChart(telemetry) {
            const now = new Date().toLocaleTimeString();
            
            // Store history for each satellite
            telemetry.forEach(sat => {
                if (!telemetryHistory[sat.sat_id]) {
                    telemetryHistory[sat.sat_id] = { labels: [], data: [] };
                }
                
                const history = telemetryHistory[sat.sat_id];
                history.labels.push(now);
                history.data.push(sat.battery_pct || 0);
                
                // Keep only last 20 points
                if (history.labels.length > 20) {
                    history.labels.shift();
                    history.data.shift();
                }
            });

            // Update chart datasets
            const colors = ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF'];
            batteryChart.data.datasets = [];
            
            Object.keys(telemetryHistory).forEach((satId, index) => {
                const history = telemetryHistory[satId];
                const sat = telemetry.find(s => s.sat_id === satId);
                if (sat) {
                    batteryChart.data.datasets.push({
                        label: sat.name || satId,
                        data: history.data,
                        borderColor: colors[index % colors.length],
                        backgroundColor: colors[index % colors.length] + '20',
                        tension: 0.1
                    });
                }
            });

            // Use the most recent labels
            const latestHistory = Object.values(telemetryHistory).find(h => h.labels.length > 0);
            if (latestHistory) {
                batteryChart.data.labels = latestHistory.labels;
            }
            
            batteryChart.update();
        }

        // Update altitude chart
        function updateAltitudeChart(telemetry) {
            const labels = telemetry.map(sat => sat.name || sat.sat_id);
            const altitudes = telemetry.map(sat => sat.orbital_elements?.alt_km || 0);

            altitudeChart.data.labels = labels;
            altitudeChart.data.datasets[0].data = altitudes;
            altitudeChart.update();
        }

        // Initialize and start updates
        initCharts();
        
        async function update() {
            const telemetry = await fetchTelemetry();
            updateDashboard(telemetry);
        }

        // Update every 2 seconds
        setInterval(update, 2000);
        update(); // Initial update
    </script>
</body>
</html>
